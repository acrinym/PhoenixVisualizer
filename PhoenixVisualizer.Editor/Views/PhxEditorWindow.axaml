<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:edit="clr-namespace:AvaloniaEdit;assembly=AvaloniaEdit"
        xmlns:r="using:PhoenixVisualizer.Rendering"
        xmlns:views="using:PhoenixVisualizer.Editor.Views"
        xmlns:cvt="using:PhoenixVisualizer.Editor.Converters"
        xmlns:vm="using:PhoenixVisualizer.Editor.ViewModels"
        x:Class="PhoenixVisualizer.Editor.Views.PhxEditorWindow"
        x:DataType="vm:PhxEditorViewModel"
        Width="1280" Height="830" Title="Phoenix Visualizer - PHX Editor">
  <Grid RowDefinitions="Auto,*" >
    <!-- Toolbar -->
    <StackPanel Orientation="Horizontal" Spacing="8" Margin="8">
      <Button Content="Import AVS"   Command="{Binding ImportAvsCommand}" />
      <Button Content="Reimport"     Command="{Binding ReimportCommand}" />
      <Button Content="New Phoenix"  Command="{Binding NewPhxVisCommand}" />
      <Button Content="Export AVS"   Command="{Binding ExportAvsCommand}" />
      <Button Content="Export PHXVis" Command="{Binding ExportPhxVisCommand}" />
      <Separator Width="12"/>
      <Button Content="Compile" Command="{Binding CompileCommand}" />
      <Button Content="Test"    Command="{Binding TestCodeCommand}" />
      <Separator Width="12"/>
      <Button Content="{Binding PreviewDockButtonText}" Command="{Binding ToggleUndockCommand}" />
      <CheckBox Content="Live Apply" IsChecked="{Binding LiveApply}" Margin="8,0,0,0"/>
      <TextBlock Text="{Binding StatusText}" Margin="12,0,0,0" VerticalAlignment="Center"/>
    </StackPanel>

    <!-- 3-pane layout -->
    <Grid Grid.Row="1" ColumnDefinitions="*,Auto,1.3*,Auto,2*">
      <!-- LEFT: Code editor (visible when Superscope selected) -->
      <Border Grid.Column="0" Background="#151515" Padding="6">
        <Grid RowDefinitions="Auto,*">
          <TextBlock Text="Unified Phoenix Code" FontWeight="Bold" Margin="0,0,0,6"/>
          <TabControl IsVisible="{Binding IsSuperscopeSelected}">
            <TabItem Header="Init">
              <edit:TextEditor x:Name="InitEditor" ShowLineNumbers="True" FontFamily="Consolas"
                               SyntaxHighlighting="C#" Document="{Binding ScriptInit, Converter={x:Static cvt:StringToDocumentConverter.Instance}}"/>
            </TabItem>
            <TabItem Header="Frame">
              <edit:TextEditor x:Name="FrameEditor" ShowLineNumbers="True" FontFamily="Consolas"
                               SyntaxHighlighting="C#" Document="{Binding ScriptFrame, Converter={x:Static cvt:StringToDocumentConverter.Instance}}"/>
            </TabItem>
            <TabItem Header="Beat">
              <edit:TextEditor x:Name="BeatEditor" ShowLineNumbers="True" FontFamily="Consolas"
                               SyntaxHighlighting="C#" Document="{Binding ScriptBeat, Converter={x:Static cvt:StringToDocumentConverter.Instance}}"/>
            </TabItem>
            <TabItem Header="Point">
              <edit:TextEditor x:Name="PointEditor" ShowLineNumbers="True" FontFamily="Consolas"
                               SyntaxHighlighting="C#" Document="{Binding ScriptPoint, Converter={x:Static cvt:StringToDocumentConverter.Instance}}"/>
            </TabItem>
          </TabControl>
        </Grid>
      </Border>

      <GridSplitter Grid.Column="1" Width="6" Background="#2B2B2B" ResizeBehavior="BasedOnAlignment" />

      <!-- MIDDLE: Catalog + Stack + Parameters -->
      <Grid Grid.Column="2" RowDefinitions="Auto,Auto,*,Auto,*" ColumnDefinitions="*">
        <!-- Catalog Header -->
        <StackPanel Orientation="Horizontal" Margin="6,0,6,6" Spacing="8">
          <TextBlock Text="Effects Catalog" FontWeight="Bold"/>
          <ComboBox Width="140"
                    SelectedItem="{Binding CatalogCategory}"
                    ItemsSource="{Binding Catalog, Converter={x:Static cvt:CatalogCategoryConverter.Instance}}"/>
          <TextBox Width="220" Watermark="Searchâ€¦" Text="{Binding CatalogFilter, UpdateSourceTrigger=PropertyChanged}"/>
        </StackPanel>
        <!-- Catalog List -->
        <ListBox Grid.Row="1" Height="160" ItemsSource="{Binding CatalogView}" SelectionMode="Single">
          <ListBox.ItemTemplate>
            <DataTemplate>
              <DockPanel Margin="4,2">
                <TextBlock Text="{Binding Category}" Foreground="#7aa" DockPanel.Dock="Right" Margin="8,0,0,0"/>
                <StackPanel>
                  <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold"/>
                  <TextBlock Text="{Binding TypeKey}" FontSize="11" Foreground="#999"/>
                </StackPanel>
              </DockPanel>
            </DataTemplate>
          </ListBox.ItemTemplate>
          <ListBox.ContextMenu>
            <ContextMenu>
              <MenuItem Header="Add to Stack" Command="{Binding AddByTypeKeyCommand}" CommandParameter="{Binding}"/>
            </ContextMenu>
          </ListBox.ContextMenu>
        </ListBox>

        <!-- Effect Stack header + buttons -->
        <DockPanel Grid.Row="2" LastChildFill="False" Margin="6,10,6,6">
          <TextBlock Text="Effect Stack" FontWeight="Bold" DockPanel.Dock="Left"/>
          <StackPanel Orientation="Horizontal" Spacing="6" DockPanel.Dock="Right">
            <Button Content="Up" Command="{Binding MoveUpCommand}"/>
            <Button Content="Down" Command="{Binding MoveDownCommand}"/>
            <Button Content="Duplicate" Command="{Binding DuplicateSelectedCommand}"/>
            <Button Content="Delete" Command="{Binding RemoveSelectedCommand}"/>
          </StackPanel>
        </DockPanel>

        <!-- Effect Stack with drag & drop reorder & accepting drops from Catalog -->
        <ListBox Grid.Row="3" x:Name="EffectStackListBox"
                 ItemsSource="{Binding EffectStack}"
                 SelectedItem="{Binding SelectedEffect}">
          <ListBox.ItemTemplate>
            <DataTemplate>
              <DockPanel Margin="4,2">
                <TextBlock Text="{Binding TypeKey}" Foreground="#8a8" DockPanel.Dock="Right" Margin="8,0,0,0"/>
                <TextBlock Text="{Binding DisplayName}"/>
              </DockPanel>
            </DataTemplate>
          </ListBox.ItemTemplate>
          <ListBox.ContextMenu>
            <ContextMenu>
              <MenuItem Header="Move Up" Command="{Binding MoveUpCommand}"/>
              <MenuItem Header="Move Down" Command="{Binding MoveDownCommand}"/>
              <MenuItem Header="Duplicate" Command="{Binding DuplicateSelectedCommand}"/>
              <MenuItem Header="Delete" Command="{Binding RemoveSelectedCommand}"/>
            </ContextMenu>
          </ListBox.ContextMenu>
        </ListBox>

        <TextBlock Grid.Row="4" Text="Parameters" FontWeight="Bold" Margin="6,12,0,6"/>
        <views:ParameterEditor Grid.Row="5" x:Name="ParameterEditor"/>
      </Grid>

      <GridSplitter Grid.Column="3" Width="6" Background="#2B2B2B" ResizeBehavior="BasedOnAlignment" />

      <!-- RIGHT: Docked Preview -->
      <Border Grid.Column="4" Background="#0E0E0E">
        <Grid>
          <r:RenderSurface x:Name="PreviewSurface"/>
        </Grid>
      </Border>
    </Grid>
  </Grid>
</Window>
